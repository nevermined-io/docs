---
title: "Requests Module"
description: "Validate payment requests with the TypeScript SDK"
icon: "shield-check"
---

The `requests` module handles request validation and access control.

## Methods

### isValidRequest

Validate an incoming request with payment token.

```typescript
const result = await payments.requests.isValidRequest(
  accessToken,
  requestBody
)
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `accessToken` | `string` | Bearer token from Authorization header |
| `requestBody` | `object` | The request body being validated |

**Returns:**

```typescript
interface ValidationResult {
  isValid: boolean
  balance: number
  reason?: string
  subscriberAddress?: string
  planId?: string
  expiresAt?: Date
}
```

**Example:**

```typescript
// Extract token from header
const authHeader = req.headers['authorization']
const token = authHeader?.substring(7) // Remove "Bearer "

const { isValid, balance, reason } = await payments.requests.isValidRequest(
  token,
  req.body
)

if (!isValid) {
  return res.status(402).json({
    error: 'Payment Required',
    reason
  })
}

// Process request...
console.log(`Credits remaining: ${balance}`)
```

### getRequests

Get request history for an agent.

```typescript
const requests = await payments.requests.getRequests({
  agentId: 'did:nv:agent-123',
  limit: 100,
  offset: 0
})
```

**Returns:**

```typescript
interface RequestRecord {
  requestId: string
  agentId: string
  planId: string
  subscriberAddress: string
  creditsUsed: number
  timestamp: Date
  status: 'success' | 'failed'
}
```

### getRequestById

Get details of a specific request.

```typescript
const request = await payments.requests.getRequestById(requestId)
```

## Validation Response Codes

| `reason` | Meaning |
|----------|---------|
| `undefined` | Valid request |
| `TOKEN_EXPIRED` | Access token has expired |
| `INSUFFICIENT_BALANCE` | Not enough credits |
| `PLAN_EXPIRED` | Time-based plan has expired |
| `INVALID_TOKEN` | Token is malformed or invalid |
| `UNAUTHORIZED` | Token doesn't grant access to this agent |

## Usage Patterns

### Express Middleware

```typescript
async function validatePayment(req, res, next) {
  const auth = req.headers['authorization']

  if (!auth?.startsWith('Bearer ')) {
    return res.status(402).json({ error: 'Payment Required' })
  }

  const token = auth.substring(7)
  const { isValid, balance, reason } = await payments.requests.isValidRequest(
    token,
    req.body
  )

  if (!isValid) {
    return res.status(402).json({
      error: 'Payment Required',
      reason
    })
  }

  req.payment = { balance }
  next()
}
```

### With Minimum Credits

```typescript
async function requireMinCredits(token, body, minCredits) {
  const { isValid, balance } = await payments.requests.isValidRequest(
    token,
    body
  )

  if (!isValid || balance < minCredits) {
    throw new Error('Insufficient credits')
  }

  return { balance }
}
```

## Types

```typescript
interface ValidationResult {
  isValid: boolean
  balance: number
  reason?: ValidationReason
  subscriberAddress?: string
  planId?: string
  expiresAt?: Date
}

type ValidationReason =
  | 'TOKEN_EXPIRED'
  | 'INSUFFICIENT_BALANCE'
  | 'PLAN_EXPIRED'
  | 'INVALID_TOKEN'
  | 'UNAUTHORIZED'

interface GetRequestsParams {
  agentId?: string
  planId?: string
  subscriberAddress?: string
  limit?: number
  offset?: number
}
```

## Next Steps

<CardGroup cols={2}>
  <Card title="Validate Requests Pattern" icon="code" href="/docs/integrate/patterns/validate-requests">
    Complete validation patterns
  </Card>
  <Card title="Charge Credits" icon="coins" href="/docs/integrate/patterns/charge-credits">
    Credit charging patterns
  </Card>
</CardGroup>
