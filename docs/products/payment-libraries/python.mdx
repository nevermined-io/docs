---
title: "Python SDK"
description: "Complete guide to the payments-py Python library"
icon: "python"
---

The `payments-py` package provides full Python support for integrating Nevermined payments into your backend services, AI agents, and data science workflows.

## Installation

```bash
pip install payments-py
```

Or with poetry:

```bash
poetry add payments-py
```

## Quick Start

```python
import os
from payments_py import Payments, PaymentOptions
from payments_py.plans import get_erc20_price_config, get_fixed_credits_config

# Initialize the client
payments = Payments.get_instance(
    PaymentOptions(
        nvm_api_key=os.environ['NVM_API_KEY'],
        environment='testing'
    )
)

# Register an agent with a payment plan
result = payments.agents.register_agent_and_plan(
    agent_metadata={'name': 'My AI Agent', 'tags': ['ai']},
    agent_api={'endpoints': [{'POST': 'https://api.example.com/query'}]},
    plan_metadata={'name': 'Pro Plan', 'description': '100 queries'},
    price_config=get_erc20_price_config(10_000_000, USDC_ADDRESS, BUILDER_ADDRESS),
    credits_config=get_fixed_credits_config(100, 1),
    access_limit='credits'
)

print(f"Agent: {result['agentId']}, Plan: {result['planId']}")
```

## Initialization Options

```python
from payments_py import Payments, PaymentOptions

options = PaymentOptions(
    nvm_api_key=os.environ['NVM_API_KEY'],  # Your Nevermined API key
    environment='testing',                    # 'testing' | 'staging' | 'production'
    app_id='my-app',                         # Optional app identifier
    version='1.0.0'                          # Optional version string
)

payments = Payments.get_instance(options)
```

## Agents Module

### Register an Agent

```python
agent = payments.agents.register_agent(
    metadata={
        'name': 'Legal Document Analyzer',
        'description': 'AI-powered legal document analysis',
        'tags': ['legal', 'ai', 'documents'],
        'dateCreated': '2024-01-01T00:00:00Z'
    },
    api={
        'endpoints': [
            {'POST': 'https://api.legalai.com/analyze'},
            {'GET': 'https://api.legalai.com/status/{id}'}
        ],
        'agentDefinitionUrl': 'https://api.legalai.com/openapi.json'
    }
)

agent_id = agent['agentId']
```

### Register Agent with Plan (Combined)

```python
from payments_py.plans import get_erc20_price_config, get_fixed_credits_config

result = payments.agents.register_agent_and_plan(
    # Agent metadata
    agent_metadata={
        'name': 'Code Review Assistant',
        'description': 'AI-powered code review',
        'tags': ['code', 'review', 'ai']
    },
    # Agent API
    agent_api={
        'endpoints': [{'POST': 'https://api.codereview.com/review'}],
        'agentDefinitionUrl': 'https://api.codereview.com/mcp.json'
    },
    # Plan metadata
    plan_metadata={
        'name': 'Developer Plan',
        'description': '500 code reviews'
    },
    # Price config: 25 USDC
    price_config=get_erc20_price_config(
        25_000_000,
        '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
        os.environ['BUILDER_ADDRESS']
    ),
    # Credits config: 500 reviews, 1 credit each
    credits_config=get_fixed_credits_config(500, 1),
    access_limit='credits'
)

agent_id = result['agentId']
plan_id = result['planId']
```

### Get Agent Details

```python
agent = payments.agents.get_agent('did:nv:agent-123')

print(agent['name'])        # Agent name
print(agent['endpoints'])   # API endpoints
print(agent['plans'])       # Associated payment plans
```

### Get Access Token

```python
import requests

# For subscribers to access an agent
credentials = payments.agents.get_agent_access_token(
    'did:nv:plan-123',
    'did:nv:agent-123'
)

# Use in requests
response = requests.post(
    agent['endpoints'][0]['url'],
    headers={
        'Authorization': f"Bearer {credentials['accessToken']}"
    },
    json={'prompt': 'Analyze this document'}
)
```

## Plans Module

### Create a Plan

```python
from payments_py.plans import get_time_based_config

plan = payments.plans.create_plan(
    agent_id='did:nv:agent-123',
    name='Enterprise Plan',
    description='Unlimited access for 30 days',
    price_config=get_erc20_price_config(100_000_000, usdc_address, builder_address),
    time_config=get_time_based_config(30 * 24 * 60 * 60),  # 30 days
    access_limit='time'
)

plan_id = plan['planId']
```

### Order a Plan (Crypto)

```python
result = payments.plans.order_plan('did:nv:plan-123')

print(result['transactionHash'])  # Blockchain tx hash
print(result['agreementId'])      # Access agreement ID
```

### Order a Plan (Fiat/Stripe)

```python
result = payments.plans.order_fiat_plan('did:nv:plan-123')

# Redirect user to Stripe checkout
checkout_url = result['url']
print(f'Complete payment at: {checkout_url}')
```

### Get Plan Balance

```python
balance = payments.plans.get_plan_balance('did:nv:plan-123')

print(balance['credits'])     # Remaining credits
print(balance['expiresAt'])   # Expiration timestamp (for time-based)
```

### Create Trial Plans

```python
# Free credits trial
trial = payments.plans.register_credits_trial_plan(
    agent_id='did:nv:agent-123',
    name='Free Trial',
    description='10 free queries',
    credits=10,
    credits_per_request=1
)

# Free time trial
time_trial = payments.plans.register_time_trial_plan(
    agent_id='did:nv:agent-123',
    name='7-Day Trial',
    description='Full access for 7 days',
    duration=7 * 24 * 60 * 60
)
```

## Requests Module

### Validate a Request

```python
from flask import request, jsonify

validation = payments.requests.is_valid_request(
    access_token,
    request_body
)

if not validation['isValid']:
    return jsonify({
        'error': 'Payment Required',
        'reason': validation['reason'],
        'plans': validation['availablePlans']
    }), 402

# Process the valid request
result = process_ai_query(request_body)
```

### Get Request History

```python
requests_list = payments.requests.get_requests(
    agent_id='did:nv:agent-123',
    limit=100,
    offset=0
)

for req in requests_list:
    print(f"{req['timestamp']}: {req['creditsUsed']} credits")
```

## x402 Module

### Generate x402 Access Token

```python
token_result = payments.x402.get_x402_access_token(
    'did:nv:plan-123',
    'did:nv:agent-123'
)

access_token = token_result['accessToken']
```

### Build x402 Payment Payload

```python
import base64
import json

payment_payload = {
    'x402Version': 2,
    'scheme': 'contract',
    'network': 'base-sepolia',
    'payload': {'session_key': access_token},
    'extensions': {
        'nevermined': {
            'info': {
                'plan_id': plan_id,
                'agent_id': agent_id,
                'max_amount': '1000000',
                'network': 'base-sepolia'
            }
        }
    }
}

# Encode for header
encoded = base64.b64encode(json.dumps(payment_payload).encode()).decode()
```

## Facilitator Module

### Verify Permissions

```python
from payments_py.x402 import NeverminedFacilitator, PaymentRequirements

facilitator = NeverminedFacilitator(
    nvm_api_key=os.environ['NVM_API_KEY'],
    environment='testing'
)

requirements = PaymentRequirements(
    plan_id='did:nv:plan-123',
    agent_id='did:nv:agent-123',
    max_amount='1000000',
    extra={'subscriber_address': '0x...'}
)

result = await facilitator.verify(payment_payload, requirements)

if not result.is_valid:
    raise Exception('Payment verification failed')
```

### Settle Permissions

```python
settlement = await facilitator.settle(payment_payload, requirements)

print(settlement.transaction_hash)
```

## Price Configuration Helpers

```python
from payments_py.plans import (
    get_erc20_price_config,
    get_native_price_config,
    get_fixed_credits_config,
    get_time_based_config,
    get_dynamic_credits_config
)

# ERC-20 token payment (e.g., USDC)
erc20_config = get_erc20_price_config(
    10_000_000,                    # Amount (with decimals)
    '0xA0b8...eB48',               # Token address
    '0xYour...Address'             # Receiver address
)

# Native token payment (e.g., ETH)
native_config = get_native_price_config(
    1_000_000_000_000_000,         # 0.001 ETH
    '0xYour...Address'
)

# Fixed credits
fixed_credits = get_fixed_credits_config(
    100,    # Total credits
    1       # Credits per request
)

# Time-based access
time_config = get_time_based_config(
    30 * 24 * 60 * 60              # 30 days in seconds
)

# Dynamic credits (variable per request)
dynamic_credits = get_dynamic_credits_config(
    1,      # Minimum per request
    10      # Maximum per request
)
```

## FastAPI Integration Example

```python
from fastapi import FastAPI, Header, HTTPException
from payments_py import Payments, PaymentOptions
import os

app = FastAPI()

payments = Payments.get_instance(
    PaymentOptions(
        nvm_api_key=os.environ['NVM_API_KEY'],
        environment='testing'
    )
)

@app.post("/query")
async def query_agent(
    request_body: dict,
    authorization: str = Header(None)
):
    if not authorization or not authorization.startswith('Bearer '):
        raise HTTPException(status_code=401, detail='Unauthorized')

    token = authorization[7:]

    validation = payments.requests.is_valid_request(token, request_body)

    if not validation['isValid']:
        raise HTTPException(
            status_code=402,
            detail={
                'error': 'Payment Required',
                'plans': validation['availablePlans']
            }
        )

    # Process the request
    result = await process_ai_query(request_body)
    return result
```

## Flask Integration Example

```python
from flask import Flask, request, jsonify
from payments_py import Payments, PaymentOptions
import os

app = Flask(__name__)

payments = Payments.get_instance(
    PaymentOptions(
        nvm_api_key=os.environ['NVM_API_KEY'],
        environment='testing'
    )
)

@app.route('/query', methods=['POST'])
def query_agent():
    auth_header = request.headers.get('Authorization')

    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({'error': 'Unauthorized'}), 401

    token = auth_header[7:]

    validation = payments.requests.is_valid_request(token, request.json)

    if not validation['isValid']:
        return jsonify({
            'error': 'Payment Required',
            'plans': validation['availablePlans']
        }), 402

    # Process the request
    result = process_ai_query(request.json)
    return jsonify(result)
```

## Error Handling

```python
from payments_py.exceptions import (
    PaymentsError,
    ValidationError,
    InsufficientCreditsError
)

try:
    payments.plans.order_plan(plan_id)
except InsufficientCreditsError:
    print('User needs to add funds')
except ValidationError as e:
    print(f'Invalid request: {e.message}')
except PaymentsError as e:
    print(f'Payments error: {e.code} - {e.message}')
```

## Type Hints

The SDK includes type hints for better IDE support:

```python
from payments_py.types import (
    Agent,
    Plan,
    PriceConfig,
    CreditsConfig,
    ValidationResult,
    OrderResult
)

def process_agent(agent: Agent) -> None:
    print(agent['name'])
```

## Next Steps

<CardGroup cols={2}>
  <Card title="FastAPI Integration" icon="python" href="/docs/integrate/add-to-your-agent/fastapi">
    Complete FastAPI integration guide
  </Card>

  <Card title="API Reference" icon="book" href="/docs/api-reference/python/installation">
    Complete API documentation
  </Card>

  <Card title="x402 Protocol" icon="link" href="/docs/integrate/platforms/x402-protocol">
    Implement HTTP 402 payment flows
  </Card>

  <Card title="Google A2A" icon="sparkles" href="/docs/integrate/platforms/google-a2a">
    Agent-to-Agent integration
  </Card>
</CardGroup>
